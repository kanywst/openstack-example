# Hypervisor: OpenStackの仮想化基盤

## 目次
- [概要](#概要)
- [OpenStackでサポートされるハイパーバイザー](#openstackでサポートされるハイパーバイザー)
- [ハイパーバイザーの種類](#ハイパーバイザーの種類)
- [Novaとハイパーバイザーの連携](#novaとハイパーバイザーの連携)
- [KVM詳細](#kvm詳細)
- [パフォーマンスと最適化](#パフォーマンスと最適化)
- [セキュリティ](#セキュリティ)
- [高可用性と耐障害性](#高可用性と耐障害性)
- [ハイパーバイザー選択のガイドライン](#ハイパーバイザー選択のガイドライン)
- [トラブルシューティング](#トラブルシューティング)
- [ベストプラクティス](#ベストプラクティス)

## 概要

ハイパーバイザー（Hypervisor）は、物理ハードウェア上で複数の仮想マシン（VM）を実行するためのソフトウェアレイヤーです。OpenStackでは、Nova（コンピュートサービス）がハイパーバイザーと連携して、仮想マシンのライフサイクル管理を行います。

ハイパーバイザーは、物理サーバーのCPU、メモリ、ストレージ、ネットワークなどのリソースを仮想化し、複数の独立した仮想マシンに割り当てます。これにより、物理リソースの効率的な利用と、柔軟なリソース管理が可能になります。

## OpenStackでサポートされるハイパーバイザー

OpenStackは、様々なハイパーバイザーをサポートしており、環境や要件に応じて選択できます。

### 主要なハイパーバイザー

1. **KVM (Kernel-based Virtual Machine)**
   - Linuxカーネルに組み込まれたオープンソースの仮想化技術
   - OpenStackでの標準的な選択肢
   - 高いパフォーマンスと安定性

2. **QEMU (Quick Emulator)**
   - ハードウェアエミュレーター
   - KVMと組み合わせて使用されることが多い
   - ハードウェア支援なしでも動作可能

3. **Xen/XenServer**
   - オープンソースのType-1ハイパーバイザー
   - パラ仮想化と完全仮想化をサポート
   - 長い歴史と成熟度

4. **VMware vSphere/ESXi**
   - 企業向けの商用ハイパーバイザー
   - 高度な管理機能と安定性
   - 既存のVMware環境との統合に適している

5. **Microsoft Hyper-V**
   - Windowsサーバー向けの仮想化技術
   - Windows環境との高い親和性
   - Active Directoryとの統合

6. **LXC/LXD (Linux Containers)**
   - コンテナベースの仮想化
   - 軽量で高速
   - システムコンテナとして機能

7. **Ironic (Bare Metal)**
   - 物理サーバーを直接管理（ハイパーバイザーなし）
   - 高性能コンピューティングに適している
   - 特殊なワークロード向け

### サポートレベル

OpenStackにおける各ハイパーバイザーのサポートレベルは異なります：

| ハイパーバイザー | サポートレベル | 成熟度 | 主な用途 |
|--------------|------------|------|--------|
| KVM          | 最高        | 高   | 一般的なクラウド環境 |
| QEMU         | 高          | 高   | 開発・テスト環境 |
| Xen          | 中〜高      | 高   | 特定のワークロード |
| VMware       | 中          | 高   | 企業環境 |
| Hyper-V      | 中          | 中   | Windows中心の環境 |
| LXC/LXD      | 低〜中      | 中   | 高密度デプロイメント |
| Ironic       | 特殊        | 中   | 高性能コンピューティング |

## ハイパーバイザーの種類

ハイパーバイザーは、アーキテクチャによって大きく2つのタイプに分類されます。

### Type-1 (ベアメタル) ハイパーバイザー

物理ハードウェア上に直接インストールされ、ホストOSを必要としないハイパーバイザーです。

```
+------------------+  +------------------+  +------------------+
| Virtual Machine 1 |  | Virtual Machine 2 |  | Virtual Machine 3 |
| (Guest OS)       |  | (Guest OS)       |  | (Guest OS)       |
+------------------+  +------------------+  +------------------+
+----------------------------------------------------------+
|                    Hypervisor                            |
+----------------------------------------------------------+
+----------------------------------------------------------+
|                    Hardware                              |
+----------------------------------------------------------+
```

特徴:
- 高いパフォーマンス
- 低いオーバーヘッド
- 優れたセキュリティ分離
- リソース管理の効率性

例:
- KVM (Linux カーネルモジュールとして)
- Xen/XenServer
- VMware ESXi
- Microsoft Hyper-V (Windows Server の役割として)

### Type-2 (ホスト型) ハイパーバイザー

既存のオペレーティングシステム上にアプリケーションとしてインストールされるハイパーバイザーです。

```
+------------------+  +------------------+  +------------------+
| Virtual Machine 1 |  | Virtual Machine 2 |  | Virtual Machine 3 |
| (Guest OS)       |  | (Guest OS)       |  | (Guest OS)       |
+------------------+  +------------------+  +------------------+
+----------------------------------------------------------+
|                    Hypervisor                            |
+----------------------------------------------------------+
+----------------------------------------------------------+
|                    Host OS                               |
+----------------------------------------------------------+
+----------------------------------------------------------+
|                    Hardware                              |
+----------------------------------------------------------+
```

特徴:
- 導入の容易さ
- ホストOSのオーバーヘッド
- 比較的低いパフォーマンス
- デスクトップ仮想化に適している

例:
- QEMU (単体で使用する場合)
- Oracle VirtualBox
- VMware Workstation/Fusion

### コンテナ型仮想化

ハイパーバイザーベースの仮想化とは異なり、ホストOSのカーネルを共有する軽量な仮想化技術です。

```
+------------------+  +------------------+  +------------------+
| Container 1      |  | Container 2      |  | Container 3      |
| (App + Libs)     |  | (App + Libs)     |  | (App + Libs)     |
+------------------+  +------------------+  +------------------+
+----------------------------------------------------------+
|                    Container Runtime                     |
+----------------------------------------------------------+
+----------------------------------------------------------+
|                    Host OS Kernel                        |
+----------------------------------------------------------+
+----------------------------------------------------------+
|                    Hardware                              |
+----------------------------------------------------------+
```

特徴:
- 非常に軽量
- 高速な起動
- 高密度のデプロイメント
- 限定的な分離

例:
- LXC/LXD
- Docker
- containerd

## Novaとハイパーバイザーの連携

OpenStackのNovaサービスは、様々なハイパーバイザーと連携するために、抽象化レイヤーとドライバーを提供しています。

### アーキテクチャ

```
+------------------------------------------------------------------+
|                        Nova Compute Node                         |
|                                                                  |
|  +----------------+    +----------------+    +----------------+   |
|  | Nova Compute   |    | Hypervisor     |    | Virtual        |   |
|  | Service        |<-->| Driver         |<-->| Machines       |   |
|  +----------------+    +----------------+    +----------------+   |
|         ^                      |                                  |
|         |                      v                                  |
|  +----------------+    +----------------+                        |
|  | Nova API       |    | Hypervisor     |                        |
|  | (Controller)   |    | (KVM, etc.)    |                        |
|  +----------------+    +----------------+                        |
|                                                                  |
+------------------------------------------------------------------+
```

### ハイパーバイザードライバー

Novaは、各ハイパーバイザーと通信するための専用ドライバーを提供しています：

1. **libvirt ドライバー**
   - KVM、QEMU、Xenなどのハイパーバイザーと通信
   - 最も広く使用され、成熟したドライバー
   - libvirt APIを使用

2. **VMware ドライバー**
   - VMware vSphere/ESXiと通信
   - vCenter Server APIを使用
   - 既存のVMware環境との統合に使用

3. **Hyper-V ドライバー**
   - Microsoft Hyper-Vと通信
   - Windows Management Instrumentation (WMI) APIを使用
   - Windows環境での使用に適している

4. **Ironic ドライバー**
   - 物理サーバーを直接管理
   - IPMIやRedfish APIを使用
   - ベアメタルプロビジョニングに使用

### 設定例

Nova設定ファイル（nova.conf）でのハイパーバイザー設定例：

```ini
[DEFAULT]
# 使用するコンピュートドライバー
compute_driver = libvirt.LibvirtDriver

[libvirt]
# 使用するハイパーバイザータイプ
virt_type = kvm
# CPU モード設定
cpu_mode = host-passthrough
# ディスクキャッシュモード
disk_cachemodes = file=none
# ライブマイグレーション設定
live_migration_uri = qemu+ssh://nova@%s/system
```

## KVM詳細

KVM（Kernel-based Virtual Machine）は、OpenStackで最も広く使用されているハイパーバイザーです。

### KVMアーキテクチャ

```
+------------------+  +------------------+  +------------------+
| Virtual Machine 1 |  | Virtual Machine 2 |  | Virtual Machine 3 |
| (QEMU Process)   |  | (QEMU Process)   |  | (QEMU Process)   |
+------------------+  +------------------+  +------------------+
+----------------------------------------------------------+
|                    Userspace                             |
+----------------------------------------------------------+
+----------------------------------------------------------+
|                    Linux Kernel                          |
|                                                          |
|  +----------------+    +----------------+                |
|  | KVM Module     |    | Other Kernel   |                |
|  | (kvm.ko)       |    | Subsystems     |                |
|  +----------------+    +----------------+                |
+----------------------------------------------------------+
+----------------------------------------------------------+
|                    Hardware with VT-x/AMD-V              |
+----------------------------------------------------------+
```

### KVMの主要コンポーネント

1. **KVMカーネルモジュール**
   - Linuxカーネルの一部として動作
   - CPUの仮想化拡張（Intel VT-x/AMD-V）を利用
   - 仮想マシンの実行環境を提供

2. **QEMU**
   - ユーザースペースのエミュレーター
   - 仮想ハードウェア（ディスク、ネットワーク、USBなど）をエミュレート
   - KVMと連携して高速な仮想化を実現

3. **libvirt**
   - 仮想化管理API
   - KVM/QEMUの管理インターフェース
   - Novaからの指示を仮想マシン操作に変換

### KVMの特徴

1. **パフォーマンス**
   - ハードウェア支援による高速な仮想化
   - ネイティブに近いCPUパフォーマンス
   - 効率的なメモリ管理（KSM、NUMA対応）

2. **機能**
   - ライブマイグレーション
   - スナップショット
   - メモリオーバーコミット
   - CPU/メモリのホットアド

3. **成熟度**
   - Linuxカーネルの一部として長期間開発
   - 広範なコミュニティサポート
   - 多くの本番環境での実績

### KVMの設定オプション

```ini
[libvirt]
# 仮想化タイプ
virt_type = kvm

# CPUモード
# - host-passthrough: ホストCPUの機能をそのまま仮想マシンに渡す
# - host-model: ホストCPUに基づいたモデルを使用
# - custom: カスタムCPUモデルを指定
cpu_mode = host-passthrough

# NUMA設定
# NUMAトポロジーを認識した配置を有効化
numa_enabled = true

# メモリオーバーコミット比率
# 1.0 = オーバーコミットなし、2.0 = 2倍のオーバーコミット
ram_allocation_ratio = 1.5

# ディスクキャッシュモード
disk_cachemodes = file=none

# I/Oモード
# - native: ネイティブAIO
# - threads: スレッドベースのI/O
disk_io = native
```

## パフォーマンスと最適化

ハイパーバイザーのパフォーマンスは、OpenStackクラウドの全体的なパフォーマンスに大きな影響を与えます。

### リソースオーバーコミット

物理リソース以上の仮想リソースを割り当てる技術です：

1. **CPUオーバーコミット**
   - 物理CPUコア数以上の仮想CPUを割り当て
   - 設定例: `cpu_allocation_ratio = 16.0`（物理コア1つに対して最大16 vCPU）
   - すべてのVMが常に100%のCPUを使用するわけではないという前提に基づく

2. **メモリオーバーコミット**
   - 物理メモリ以上の仮想メモリを割り当て
   - 設定例: `ram_allocation_ratio = 1.5`（物理メモリの1.5倍まで割り当て可能）
   - KSM（Kernel Samepage Merging）による重複ページの共有

3. **ディスクオーバーコミット**
   - シンプロビジョニングによる仮想ディスクの割り当て
   - 実際に使用される分だけ物理ストレージを消費

### CPUの最適化

1. **CPU Pinning**
   - 特定の仮想CPUを特定の物理CPUコアに固定
   - 設定例:
     ```ini
     [compute]
     cpu_dedicated_set = 0-7
     cpu_shared_set = 8-15
     ```

2. **NUMA対応**
   - Non-Uniform Memory Access (NUMA) トポロジーを認識
   - メモリアクセスの局所性を最適化
   - 設定例:
     ```ini
     [compute]
     numa_nodes = 2
     [libvirt]
     numa_enabled = true
     ```

3. **CPU機能の透過**
   - ホストCPUの機能を仮想マシンに直接渡す
   - 設定例: `cpu_mode = host-passthrough`

### メモリの最適化

1. **Huge Pages**
   - 大きなメモリページサイズを使用（通常2MBまたは1GB）
   - TLBミスを減少させ、パフォーマンスを向上
   - 設定例:
     ```ini
     [libvirt]
     hw_machine_type = x86_64=q35
     mem_stats_period_seconds = 0
     ```

2. **KSM (Kernel Samepage Merging)**
   - 同一内容のメモリページを共有
   - メモリ使用効率の向上
   - 設定例:
     ```
     # /etc/ksmtuned.conf
     KSM_THRES_COEF=20
     KSM_SLEEP_MSEC=100
     ```

### ストレージの最適化

1. **キャッシュモード**
   - ディスクI/Oのキャッシュ設定
   - 設定例: `disk_cachemodes = file=none`（データ整合性優先）
   - または: `disk_cachemodes = file=writethrough`（パフォーマンスとデータ整合性のバランス）

2. **I/Oスケジューラ**
   - ディスクI/Oのスケジューリングアルゴリズム
   - 設定例: `echo deadline > /sys/block/sda/queue/scheduler`

3. **ストレージバックエンド**
   - ローカルSSD、共有ストレージ（Ceph、NFS）など
   - 適切なドライバーとプロトコルの選択

### ネットワークの最適化

1. **SR-IOV (Single Root I/O Virtualization)**
   - 仮想マシンに直接ネットワークデバイスへのアクセスを提供
   - 低レイテンシ、高スループット
   - 設定例:
     ```ini
     [pci]
     passthrough_whitelist = {"vendor_id": "8086", "product_id": "10ed"}
     ```

2. **vhost-net**
   - カーネル空間での効率的なネットワーク処理
   - 設定例: `vhost_net_enabled = true`

3. **マルチキュー**
   - 複数のCPUコアでネットワーク処理を分散
   - 設定例: `hw_vif_multiqueue_enabled = true`

## セキュリティ

ハイパーバイザーセキュリティは、クラウド環境全体のセキュリティにとって重要です。

### 分離メカニズム

1. **ハードウェア分離**
   - Intel VT-x/AMD-V: CPU仮想化拡張
   - Intel VT-d/AMD-Vi: I/Oメモリ管理ユニット仮想化
   - 設定例: BIOSでVT-x、VT-dを有効化

2. **カーネルレベルの分離**
   - SELinux/AppArmor: 強制アクセス制御
   - Seccomp: システムコール制限
   - 設定例: `security_driver = "selinux"`

3. **リソース制限**
   - cgroups: リソース使用量の制限
   - 設定例: `mem_limit = 4G`（メモリ制限）

### 脆弱性対策

1. **定期的なアップデート**
   - ハイパーバイザーソフトウェアの最新化
   - セキュリティパッチの適用

2. **不要な機能の無効化**
   - 使用しない仮想デバイスの無効化
   - 設定例: `enabled_filters = NoEmulatorThreadFilter`

3. **セキュアブート**
   - 署名されたカーネルのみ起動
   - UEFI Secure Bootの有効化

### 監視と検出

1. **ログ監視**
   - ハイパーバイザーログの集中管理
   - 異常アクティビティの検出

2. **完全性監視**
   - ファイルシステムの完全性チェック
   - 設定例: AIDE (Advanced Intrusion Detection Environment)の導入

3. **セキュリティスキャン**
   - 定期的な脆弱性スキャン
   - コンプライアンスチェック

## 高可用性と耐障害性

ハイパーバイザーレベルでの高可用性と耐障害性は、サービスの継続性を確保するために重要です。

### ライブマイグレーション

実行中の仮想マシンを別のホストに移動する機能です：

```
+----------------+                       +----------------+
| Compute Node A |                       | Compute Node B |
|                |                       |                |
| +------------+ |                       | +------------+ |
| | VM         | |  Live Migration      | | VM         | |
| |            | |--------------------->| |            | |
| +------------+ |                       | +------------+ |
+----------------+                       +----------------+
```

設定例:
```ini
[libvirt]
live_migration_uri = qemu+ssh://nova@%s/system
live_migration_completion_timeout = 800
live_migration_progress_timeout = 150
```

### 障害検出と復旧

1. **ホスト障害検出**
   - OpenStack Fencerによる障害検出
   - Pacemaker/Corosyncによるクラスタ監視

2. **インスタンス退避 (Evacuation)**
   - 障害ホストからの仮想マシン退避
   - 設定例: `evacuate --on-shared-storage <server>`

3. **自動復旧**
   - 障害インスタンスの自動再起動
   - 設定例: `nova server-group-create --policy anti-affinity <name>`

### 冗長構成

1. **コンピュートノードの冗長化**
   - 複数のコンピュートノードによる負荷分散
   - N+1または2N冗長構成

2. **ストレージの冗長化**
   - 共有ストレージ（Ceph、NFS）の使用
   - データレプリケーション

3. **ネットワークの冗長化**
   - 複数のネットワークパス
   - ボンディングインターフェース

## ハイパーバイザー選択のガイドライン

OpenStack環境に適したハイパーバイザーを選択するためのガイドラインです。

### 選択基準

1. **パフォーマンス要件**
   - 高性能が必要な場合: KVM、Xen
   - 高密度が必要な場合: LXC/LXD
   - 特殊なワークロード: Ironic（ベアメタル）

2. **既存環境との統合**
   - VMware環境がある場合: VMware vSphere
   - Windows環境が中心の場合: Hyper-V
   - Linux環境が中心の場合: KVM

3. **管理の容易さ**
   - 使い慣れた技術
   - 管理ツールの充実度
   - ドキュメントとコミュニティサポート

4. **コスト**
   - オープンソース: KVM、Xen、LXC/LXD
   - 商用: VMware vSphere、Hyper-V（ライセンス費用）

### ユースケース別推奨

| ユースケース | 推奨ハイパーバイザー | 理由 |
|------------|-----------------|------|
| 一般的なクラウド環境 | KVM | バランスの取れたパフォーマンス、成熟度、コスト |
| 高性能コンピューティング | Ironic（ベアメタル） | オーバーヘッドなし、直接ハードウェアアクセス |
| 高密度ホスティング | LXC/LXD | 軽量、リソース効率が高い |
| エンタープライズ環境 | VMware vSphere | 高度な管理機能、エンタープライズサポート |
| Windows中心の環境 | Hyper-V | Windows統合、ライセンス最適化 |

## トラブルシューティング

ハイパーバイザー関連の一般的な問題と解決策を紹介します。

### 一般的な問題

1. **パフォーマンス低下**
   - 症状: 仮想マシンの応答が遅い、高負荷
   - 原因: リソース競合、オーバーコミット、設定ミスなど
   - 解決策:
     - `top`、`htop`、`iotop`などでリソース使用状況を確認
     - オーバーコミット比率の調整
     - CPUピニングの設定

2. **仮想マシン起動失敗**
   - 症状: インスタンスがERROR状態になる
   - 原因: リソース不足、ハイパーバイザーの問題、権限エラーなど
   - 解決策:
     - ログの確認: `/var/log/libvirt/libvirtd.log`
     - リソース可用性の確認
     - SELinux/AppArmorの設定確認

3. **ライブマイグレーション失敗**
   - 症状: マイグレーションがタイムアウトまたはエラー
   - 原因: ネットワーク問題、非互換CPU、メモリ不足など
   - 解決策:
     - CPU互換性の確認
     - 十分なネットワーク帯域幅の確保
     - マイグレーションタイムアウト設定の調整

### 診断コマンド

```bash
# ハイパーバイザー情報の表示
openstack hypervisor list
openstack hypervisor show <hypervisor_id>

# ハイパーバイザー統計の表示
openstack hypervisor stats show

# libvirtドメイン情報の表示
virsh list --all
virsh dominfo <domain>

# libvirtドメインのXML設定表示
virsh dumpxml <domain>

# QEMUプロセスの確認
ps aux | grep qemu

# ハイパーバイザーのログ確認
tail -f /var/log/libvirt/libvirtd.log
tail -f /var/log/qemu/<domain>.log

# ハードウェア仮想化サポートの確認
grep -E 'vmx|svm' /proc/cpuinfo
```

## ベストプラクティス

OpenStack環境でハイパーバイザーを効果的に活用するためのベストプラクティスを紹介します。

### 設計と構成

1. **適切なハードウェア選定**
   - 仮想化支援機能（Intel VT-x/AMD-V）を持つCPU
   - 十分なメモリと高速なストレージ
   - 冗長化されたネットワークインターフェース

2. **ハイパーバイザーの標準化**
   - 環境内で同一のハイパーバイザーバージョンを使用
   - パッチレベルの統一
   - 設定の標準化

3. **リソース計画**
   - 適切なオーバーコミット比率の設定
   - 将来の拡張を考慮した設計
   - ワークロードに基づいたサイジング

### 運用と管理

1. **定期的なメンテナンス**
   - セキュリティパッチの適用
   - 定期的な再起動計画
   - ライブマイグレーションを活用したメンテナンス

2. **監視とアラート**
   - リソース使用率の監視
   - パフォーマンスメトリクスの収集
   - 異常検知と自動アラート

3. **バックアップと復旧**
   - 仮想マシンのスナップショット
   - ハイパーバイザー設定のバックアップ
   - 障害復旧手順の文書化と定期的なテスト

### パフォーマンスチューニング

1. **ワークロード別の最適化**
   - 計算集約型: CPU最適化（ピニング、NUMA）
   - メモリ集約型: Huge Pages、KSM
   - I/O集約型: ストレージとネットワークの最適化

2. **不要な機能の無効化**
   - 使用しない仮想デバイスの無効化
   - エミュレーションよりパススルーを優先
   - オーバーヘッドの削減

3. **定期的なパフォーマンス評価**
   - ベンチマークテストの実施
   - ボトルネックの特定と解消
   - 継続的な改善

## まとめ

ハイパーバイザーは、OpenStackクラウド環境の基盤となる重要なコンポーネントです。適切なハイパーバイザーの選択と最適化により、パフォーマンス、セキュリティ、可用性を向上させることができます。

OpenStackでは、KVMが最も広く使用されていますが、環境や要件に応じて他のハイパーバイザーも選択できます。各ハイパーバイザーの特性を理解し、適切に設定・運用することで、効率的で信頼性の高いクラウド環境を構築できます。

ハイパーバイザーテクノロジーは常に進化しており、新しい機能や最適化手法が登場しています。最新の動向を把握し、継続的に環境を改善していくことが重要です。
