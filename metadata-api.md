# Metadata API

- [Metadata API](#metadata-api)
  - [概要](#概要)
  - [アーキテクチャ](#アーキテクチャ)
    - [コンポーネント間の連携](#コンポーネント間の連携)
  - [提供される情報](#提供される情報)
    - [基本メタデータ](#基本メタデータ)
    - [ネットワーク情報](#ネットワーク情報)
    - [セキュリティ情報](#セキュリティ情報)
    - [カスタム情報](#カスタム情報)
  - [アクセス方法](#アクセス方法)
    - [1. 直接HTTPリクエスト](#1-直接httpリクエスト)
    - [2. EC2互換エンドポイント](#2-ec2互換エンドポイント)
    - [3. Cloud-Init経由](#3-cloud-init経由)
    - [4. OpenStackクライアントツール](#4-openstackクライアントツール)
  - [セキュリティ](#セキュリティ)
    - [アクセス制限](#アクセス制限)
    - [メタデータプロキシ](#メタデータプロキシ)
    - [暗号化](#暗号化)
  - [ConfigDriveとの比較](#configdriveとの比較)
    - [ConfigDriveの概要](#configdriveの概要)
    - [Metadata API vs ConfigDrive](#metadata-api-vs-configdrive)
    - [使い分け](#使い分け)
  - [カスタムメタデータ](#カスタムメタデータ)
    - [カスタムメタデータの設定](#カスタムメタデータの設定)
    - [カスタムメタデータの取得](#カスタムメタデータの取得)
    - [カスタムメタデータの活用例](#カスタムメタデータの活用例)
  - [トラブルシューティング](#トラブルシューティング)
    - [一般的な問題](#一般的な問題)
    - [診断コマンド](#診断コマンド)
  - [高可用性と耐障害性](#高可用性と耐障害性)
    - [高可用性アーキテクチャ](#高可用性アーキテクチャ)
    - [冗長化の方法](#冗長化の方法)
    - [フェイルオーバー](#フェイルオーバー)
  - [ベストプラクティス](#ベストプラクティス)
    - [設計と構成](#設計と構成)
    - [運用と監視](#運用と監視)
    - [セキュリティ対策](#セキュリティ対策)
  - [まとめ](#まとめ)

## 概要

OpenStackのMetadata APIは、仮想マシンインスタンスが自身に関するメタデータ情報を取得するためのHTTPベースのサービスです。このサービスにより、インスタンスは起動時や実行中に、自身のホスト名、IPアドレス、SSHキー、ユーザーデータなどの情報にアクセスできます。

Metadata APIは、Cloud-Initなどの初期化ツールと連携して、インスタンスの自動設定や初期化を可能にする重要なコンポーネントです。また、EC2互換のメタデータサービスも提供しており、AWS EC2向けに開発されたアプリケーションやツールとの互換性を確保しています。

## アーキテクチャ

Metadata APIは、Nova（コンピュートサービス）の一部として実装されており、Neutron（ネットワークサービス）と連携して動作します。

```
+------------------------------------------------------------------+
|                     OpenStack Controller                         |
|                                                                  |
|  +----------------+    +----------------+    +----------------+   |
|  | Nova API       |    | Nova Metadata  |    | Neutron        |   |
|  | Service        |<-->| API Service    |<-->| Service        |   |
|  +----------------+    +----------------+    +----------------+   |
|         ^                      ^                     ^            |
|         |                      |                     |            |
|         v                      v                     v            |
|  +----------------+    +----------------+    +----------------+   |
|  | Nova Database  |    | Instance       |    | Network        |   |
|  |                |    | Metadata       |    | Configuration  |   |
|  +----------------+    +----------------+    +----------------+   |
|                                                                  |
+------------------------------------------------------------------+
                                |
                                v
+------------------------------------------------------------------+
|                     Compute Node                                 |
|                                                                  |
|  +----------------+    +----------------+                        |
|  | Nova Compute   |    | Instance       |                        |
|  |                |<-->| (Virtual       |                        |
|  +----------------+    | Machine)       |                        |
|                        +----------------+                        |
|                               |                                  |
|                               v                                  |
|                        +----------------+                        |
|                        | Cloud-Init     |                        |
|                        |                |                        |
|                        +----------------+                        |
|                                                                  |
+------------------------------------------------------------------+
```

### コンポーネント間の連携

1. **Nova Metadata API Service**
   - インスタンスからのメタデータリクエストを処理
   - Novaデータベースからインスタンス情報を取得
   - ユーザーデータやSSHキーなどの情報を提供

2. **Neutron Metadata Agent**
   - ネットワーク分離環境でのメタデータアクセスを可能にする
   - インスタンスからのリクエストをNova Metadata APIに転送
   - ネットワークネームスペース間のルーティングを処理

3. **Nova Compute**
   - インスタンスの作成と管理
   - メタデータ情報の初期設定

4. **Cloud-Init**
   - インスタンス内で動作し、メタデータAPIにアクセス
   - 取得した情報を基にインスタンスを設定

## 提供される情報

Metadata APIは、インスタンスに関する様々な情報を提供します。

### 基本メタデータ

- **インスタンスID**: インスタンスの一意の識別子
- **ホスト名**: インスタンスに割り当てられたホスト名
- **プロジェクトID**: インスタンスが所属するプロジェクト（テナント）のID
- **アベイラビリティゾーン**: インスタンスが配置されているアベイラビリティゾーン
- **起動インデックス**: 同時に起動された複数のインスタンスの中での順序
- **作成日時**: インスタンスが作成された日時
- **フレーバー情報**: インスタンスのサイズ（CPU、メモリ、ディスク）

### ネットワーク情報

- **IPアドレス**: インスタンスに割り当てられたIPアドレス（IPv4/IPv6）
- **MACアドレス**: ネットワークインターフェースのMACアドレス
- **サブネット情報**: サブネットマスク、ゲートウェイなど
- **DNSサーバー**: 名前解決に使用するDNSサーバーのアドレス

### セキュリティ情報

- **SSHパブリックキー**: インスタンスに配置するSSH公開鍵
- **セキュリティグループ**: 適用されているセキュリティグループのルール

### カスタム情報

- **ユーザーデータ**: インスタンス作成時にユーザーが指定したカスタムデータ
- **カスタムメタデータ**: キーと値のペアで指定されたカスタムメタデータ

## アクセス方法

インスタンスからMetadata APIにアクセスする方法は複数あります。

### 1. 直接HTTPリクエスト

インスタンス内から、特定のIPアドレス（通常は `169.254.169.254`）にHTTPリクエストを送信します：

```bash
# 基本的なメタデータの取得
curl http://169.254.169.254/openstack/latest/meta_data.json

# ユーザーデータの取得
curl http://169.254.169.254/openstack/latest/user_data

# ネットワーク設定の取得
curl http://169.254.169.254/openstack/latest/network_data.json
```

### 2. EC2互換エンドポイント

EC2互換のメタデータサービスも提供されています：

```bash
# インスタンスIDの取得
curl http://169.254.169.254/latest/meta-data/instance-id

# パブリックIPの取得
curl http://169.254.169.254/latest/meta-data/public-ipv4

# ユーザーデータの取得
curl http://169.254.169.254/latest/user-data
```

### 3. Cloud-Init経由

Cloud-Initは、起動時に自動的にMetadata APIにアクセスし、設定情報を取得します：

```bash
# Cloud-Initが取得したデータの確認
cat /var/lib/cloud/instance/user-data.txt
cat /var/lib/cloud/instance/cloud-config.txt

# データソース情報の確認
cloud-init query --all
```

### 4. OpenStackクライアントツール

OpenStackのコマンドラインツールを使用して、外部からインスタンスのメタデータを確認することもできます：

```bash
# インスタンスのメタデータを表示
openstack server show <server_id>

# インスタンスのメタデータを取得
openstack server metadata show <server_id>
```

## セキュリティ

Metadata APIは、インスタンスに重要な情報を提供するため、適切なセキュリティ対策が必要です。

### アクセス制限

1. **ネットワークレベルの制限**
   - メタデータサービスへのアクセスは、インスタンスのネットワークインターフェースからのみ許可
   - 他のインスタンスからのアクセスを防止

2. **Neutron Security Group**
   - メタデータサービスへのアクセスを許可するセキュリティグループルールの設定
   - 不要なポートの遮断

### メタデータプロキシ

Neutronは、メタデータプロキシを提供して、ネットワーク分離環境でのセキュアなアクセスを実現します：

```
+----------------+     +----------------+     +----------------+
| Instance       |---->| Neutron        |---->| Nova Metadata  |
|                |     | Metadata Proxy |     | API            |
+----------------+     +----------------+     +----------------+
```

プロキシは以下の機能を提供します：

- インスタンスの認証
- リクエストの検証
- 適切なメタデータの提供

### 暗号化

1. **HTTPSサポート**
   - メタデータサービスへのHTTPS接続のサポート
   - 通信の暗号化

2. **トークンベースの認証**
   - 一部のメタデータアクセスにトークンを要求
   - 不正アクセスの防止

## ConfigDriveとの比較

ConfigDriveは、Metadata APIの代替手段として、インスタンスにメタデータを提供する方法です。

### ConfigDriveの概要

ConfigDriveは、インスタンスにアタッチされる特殊なディスクで、メタデータ情報を含みます：

```
+----------------+     +----------------+
| Instance       |     | Config Drive   |
|                |---->| (ISO/VFAT)     |
| +------------+ |     | +------------+ |
| | Cloud-Init  | |     | | Metadata   | |
| +------------+ |     | +------------+ |
+----------------+     +----------------+
```

### Metadata API vs ConfigDrive

| 特性 | Metadata API | ConfigDrive |
|------|-------------|-------------|
| アクセス方法 | HTTPリクエスト | ファイルシステムマウント |
| ネットワーク要件 | ネットワーク接続が必要 | ネットワーク接続不要 |
| 動的更新 | 最新情報を提供可能 | 起動時の情報のみ（静的） |
| セキュリティ | ネットワークセキュリティに依存 | 物理的アクセス制限に依存 |
| 耐障害性 | メタデータサービスの可用性に依存 | インスタンスに直接アタッチされるため依存性が低い |

### 使い分け

1. **Metadata APIの適用場面**
   - 標準的なネットワーク環境
   - 動的に変更される可能性のあるメタデータ
   - クラウド環境の標準機能を活用したい場合

2. **ConfigDriveの適用場面**
   - ネットワーク接続が制限された環境
   - メタデータサービスにアクセスできない環境
   - 高いセキュリティ要件がある場合

## カスタムメタデータ

OpenStackでは、インスタンスにカスタムメタデータを追加することができます。

### カスタムメタデータの設定

```bash
# インスタンス作成時にメタデータを設定
openstack server create --image <image> --flavor <flavor> \
  --metadata key1=value1 --metadata key2=value2 <server_name>

# 既存のインスタンスにメタデータを設定
openstack server set --property key1=value1 <server_id>
```

### カスタムメタデータの取得

インスタンス内からは、Metadata APIを通じてカスタムメタデータにアクセスできます：

```bash
# OpenStackメタデータ形式
curl http://169.254.169.254/openstack/latest/meta_data.json | jq .meta

# EC2互換形式
curl http://169.254.169.254/latest/meta-data/meta-data/
```

### カスタムメタデータの活用例

1. **環境識別**
   - `environment=production`
   - `role=web-server`

2. **デプロイメント情報**
   - `version=1.2.3`
   - `deploy_date=2023-04-01`

3. **運用情報**
   - `owner=operations-team`
   - `backup_schedule=daily`

## トラブルシューティング

Metadata APIに関する一般的な問題と解決策を紹介します。

### 一般的な問題

1. **メタデータサービスにアクセスできない**
   - 症状: `curl: (7) Failed to connect to 169.254.169.254 port 80: Connection refused`
   - 原因: ネットワーク設定の問題、メタデータサービスの停止など
   - 解決策:
     - ネットワーク接続の確認
     - Neutron Metadata Agentの状態確認
     - Nova Metadata APIサービスの状態確認

2. **メタデータが正しく反映されない**
   - 症状: Cloud-Initが正しく設定を適用しない
   - 原因: メタデータの形式エラー、Cloud-Initの設定問題など
   - 解決策:
     - メタデータの形式を確認
     - Cloud-Initのログを確認
     - 手動でメタデータを取得して内容を確認

3. **パフォーマンスの問題**
   - 症状: メタデータの取得に時間がかかる
   - 原因: ネットワーク遅延、サービス負荷など
   - 解決策:
     - メタデータサービスのスケーリング
     - キャッシュの設定
     - ConfigDriveの使用検討

### 診断コマンド

```bash
# メタデータサービスの接続性テスト
curl -v http://169.254.169.254/openstack/latest/meta_data.json

# Neutron Metadata Agentの状態確認
systemctl status neutron-metadata-agent

# Nova Metadata APIサービスの状態確認
systemctl status nova-api-metadata

# ネットワーク接続の確認
ip route
iptables -L

# ログの確認
tail -f /var/log/nova/nova-api-metadata.log
tail -f /var/log/neutron/metadata_agent.log
```

## 高可用性と耐障害性

大規模な環境では、Metadata APIの高可用性と耐障害性が重要です。

### 高可用性アーキテクチャ

```
+----------------+     +----------------+     +----------------+
| Load Balancer  |---->| Nova Metadata  |     | Nova Metadata  |
|                |     | API (Node 1)   |     | API (Node 2)   |
+----------------+     +----------------+     +----------------+
        |                      |                     |
        v                      v                     v
+------------------------------------------------------------------+
|                     Shared Database                              |
+------------------------------------------------------------------+
```

### 冗長化の方法

1. **複数のMetadata APIサーバー**
   - 複数のコントローラーノードにMetadata APIサービスを配置
   - ロードバランサーによる負荷分散

2. **Neutron Metadata Agentの冗長化**
   - 複数のネットワークノードにMetadata Agentを配置
   - HAProxyなどによる冗長化

3. **データベースの冗長化**
   - Galera ClusterなどによるMySQLデータベースの冗長化
   - データの一貫性と可用性の確保

### フェイルオーバー

1. **自動フェイルオーバー**
   - サービス監視による障害検出
   - 自動的な切り替え

2. **手動フェイルオーバー**
   - 計画的なメンテナンス時の切り替え
   - 障害復旧後の切り戻し

## ベストプラクティス

Metadata APIを効果的に活用するためのベストプラクティスを紹介します。

### 設計と構成

1. **適切なスケーリング**
   - インスタンス数に応じたMetadata APIサーバーの配置
   - 負荷に応じたリソース割り当て

2. **ネットワーク設計**
   - メタデータトラフィック用の専用ネットワーク
   - 適切なセキュリティグループの設定

3. **キャッシング戦略**
   - クライアント側でのメタデータキャッシング
   - サーバー側でのレスポンスキャッシング

### 運用と監視

1. **定期的な監視**
   - メタデータサービスの可用性監視
   - パフォーマンスメトリクスの収集と分析

2. **ログ管理**
   - 集中ログ管理の実装
   - 異常アクセスの検出

3. **バックアップと復旧**
   - メタデータサービス設定のバックアップ
   - 障害時の復旧手順の整備

### セキュリティ対策

1. **最小権限の原則**
   - 必要最小限のメタデータへのアクセス許可
   - 機密情報の適切な管理

2. **定期的なセキュリティレビュー**
   - セキュリティ設定の定期的な見直し
   - 脆弱性スキャンの実施

3. **暗号化の適用**
   - 機密性の高いメタデータの暗号化
   - 通信の暗号化（HTTPS）

## まとめ

OpenStackのMetadata APIは、クラウド環境におけるインスタンスの初期化と設定を自動化するための重要なコンポーネントです。インスタンスに関するメタデータ、ネットワーク設定、セキュリティ情報などを提供し、Cloud-Initなどの初期化ツールと連携して動作します。

適切に設計・構成・運用されたMetadata APIは、OpenStackクラウド環境の信頼性、セキュリティ、自動化を向上させます。特に大規模環境では、高可用性と耐障害性を考慮した設計が重要です。

また、ConfigDriveとの適切な使い分けや、カスタムメタデータの活用により、より柔軟で効率的なクラウド環境を実現できます。
